```{r}
library(tidyverse)
library(skimr)
library(survival)
library(survminer)
library(fitdistrplus)

root = 'C://Users//corma//Documents//GitHub//WW2_Analysis//'
setwd(root)
```
```{r}
# read in the survival analysis data
uboats = read_csv("uboats_cleaned.csv")

# if Sunk, Scuttled, Surrendered, Captured, or Missing, then 1, else 0
uboats = uboats %>%
  mutate(event = ifelse(Fate_Event %in% c("Sunk"), 1, 0), notable = ifelse(`Notable Commanders` != 'NA', 1, 0))
uboats = uboats %>%
  mutate(notable = ifelse(is.na(notable), 0, notable))
```
```{r}
# now active service
overall_fit = survfit(Surv(Active_Service, event) ~ Type, data = uboats %>% filter(Type %in% c("VIIC", "XXI", "VIIC/41", "IXC/40", "XXIII")))
ggsurvplot(overall_fit, data = uboats, pval = TRUE, surv.median.line = "hv", conf.int = TRUE) + ggtitle("KM curve for U-Boats by Type")
```

```{r}
# perform a test to see if uboats with notable commanders last longer
overall_fit = survfit(Surv(Active_Service, event) ~ notable, data = uboats)
ggsurvplot(overall_fit, data = uboats, pval = TRUE, surv.median.line = "hv", conf.int = TRUE) + ggtitle("KM curve for U-Boats with Notable Commanders")
```

```{r}
# a km curve for commissioned years
uboats = uboats %>%
  mutate(commish_year = as.numeric(str_sub(Commissioned, 1, 4)))
year_fit = survfit(Surv(Active_Service, event) ~ commish_year, data = uboats)
ggsurvplot(year_fit, data = uboats, pval = TRUE, surv.median.line = "hv", conf.int = TRUE) + ggtitle("KM curve for U-Boats by Commissioned Year")
```


----------------------
# Tidyverse Time
```{r}
library(tidyverse)
library(devtools)

setwd("C:/Users/corma/Documents/GitHub/WW2_Analysis/survivalverse")
load_all()
```
```{r}
?geom_coxph
```
```{r}
p = mfg %>% ggplot()

#Basic coxph graph
p + geom_coxph(ttf, status, deviceType)

#Failure plot with strata and different confidence intervals
p + geom_coxph(ttf, status, deviceType, mfgLocation, failure = T, conf.int = 0.5)

#Using faceting and inheritance
# p + geom_coxph(ttf, status, deviceType, facet_x = mfgLocation, conf.int = F) + geom_survreg()
```
```{r}
sa_p = uboats %>% ggplot() + theme_classic()
sa_p + geom_coxph('Active_Service', 'Status', 'Type')
```
